/* 
 lithe 
 @author xiaojue [designsor@gmail.com] 
 @fileoverview a javascript common loader 
 @vserion 0.1.9 
 */
(function(t,e){function n(t,e){return e=e||_,e?e.getElementsByTagName(t):e}function r(){}function i(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function a(t){return"[object Function]"===E.call(t)}function u(t){var e={};return $(t,function(t){e[t]=1}),tool.keys(e)}function o(t,e){return t.getAttribute(e)}function c(t){var e=[];return t.replace(q,"").replace(A,function(t,n){e.push(n)}),u(e)}function s(){this.map={}}function f(){var t=path.match(/[^?]*(?=\/.*$)/);return(t?t[0]:".")+"/"}function h(){var t=/([^:\/])\/\/+/g;if(t.lastIndex=0,t.test(path)&&(path=path.replace(t,"$1/")),-1===path.indexOf("."))return path;for(var e,n=path.split("/"),r=[],i=0;n.length>i;i++)if(e=n[i],".."===e){if(0===r.length)throw Error("The path is invalid: "+path);r.pop()}else"."!==e&&r.push(e);return r.join("/")}function p(t){t=h(t);var e=t.charAt(t.length-1);return"/"===e?t:("#"===e?t=t.slice(0,-1):-1!==t.indexOf("?")||/\.(?:js)$/.test(t)||(t+=".js"),t.indexOf(":80/")>0&&(t=t.replace(":80/","/")),t)}function l(t,e){return e=f(e||O.basepath),url="",0===t.indexOf("./")||0===t.indexOf("../")?(0===t.indexOf("./")&&(t=t.substring(2)),url=e+t):url="/"===t.charAt(0)&&"/"!==t.charAt(1)?e+t.substring(1):e+"/"+t,p(url)}function d(t,e){return D[t]?(e(),void 0):I[t]?(z[t].push(e),void 0):(I[t]=!0,z[t]=[e],v(t,function(){D[t]=!0,delete I[t];var e=z[t];e&&(delete z[t],$(e,function(t){t()}))},S),void 0)}function v(t,n,r){var i=g("script",r);i.onload=i.onerror=i.onreadystatechange=function(){/loaded|complete|undefined/.test(i.readyState)&&(i.onload=i.onerror=i.onreadystatechange=null,i.parentNode&&!B&&i.parentNode.removeChild(i),i=e,a(n)&&n())}}function g(t,e){var n=_.createElement(t);return e&&(n.charset=e),n}function m(t){if(!t||t.status!==O.status.save)return!1;var e=t.dependencies;if(e.length){if(y(e,J))return!0;for(var n=0;e.length>n;n++)if(m(O.cache[e[n]]))return!0}return J.pop(),!1}function y(t,e){var n=t.concat(e);return n.length>u(n).length}function x(t){return k(t.dependencies,function(e){return J.push(t.id),!m(O.cache[e])})}function O(t){this.id=t,this.status=0,this.dependencies=[],this.exports=null,this.parent=[],this.factory=r}var b=!(typeof window===e||!t.navigator||!t.document);if(b){var _=t.document,j=Array.prototype,w=Object,E=w.prototype.toString,q=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/gm,A=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,$=j.forEach?function(t,e){t.forEach(e)}:function(t,e){for(var n=0;t.length>n;n++)e(t[n],n,t)},k=j.filter?function(t,e){return t.filter(e)}:function(){var t=[];return $(arr,function(e,n,r){fn(e,n,r)&&t.push(e)}),t},N=j.map?function(t,e){return t.map(e)}:function(t,e){var n=[];return $(t,function(t,r,i){n.push(e(t,r,i))}),n};w.keys?w.keys:function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n);return e},j.indexOf?function(t,e){return t.indexOf(e)}:function(t,e){for(var n=0;t.length>n;n++)if(t[n]===e)return n;return-1},i(s.prototype,{trigger:function(t,e){var n=this.map[t];n&&$(n,function(t){t.apply(this,e)})},on:function(t,e){this.map[t]?this.map[t].push(e):this.map[t]=[e]}});var S=(_.head||n("head")[0]||_.documentElement,"utf-8"),C=n("script"),M=C[C.length-1],P=o(M,"data-path")||M.src||o(M,"src"),T=o(M,"data-config"),B="true"===o(M,"data-debug"),F=o(M,"data-main"),I={},z={},D={},G=[],H={created:0,save:1,ready:2,compiling:3,compiled:4},J=[];i(O,new s),i(O,{basepath:P,config:T,cache:{},get:function(t){return O.cache[t]||(O.cache[t]=new O(t))},define:function(t,e){var n=c(""+e),r={id:t,deps:n,factory:e};this.trigger("initMeta",[r]),G.push(r)},require:function(t,e){O._fetch(t,function(){var n=N(t,function(t){return t?O.cache[t]._compile():null});a(e)&&e.apply(null,n)})},_fetch:function(t,e){function n(t){(t||{}).status<H.ready&&(t.status=H.ready),--a,0===a&&e()}var r=k(t,function(t){return t=l(t),t&&(!O.cache[t]||O.cache[t].status<H.ready)}),i=r.length;if(0===i)return e(),void 0;var a=i;$(r,function(t){function e(){if($(G,function(e){r._save(e,t)}),G=[],r.status>=H.save){var e=x(r);e.length?O._fetch(e,function(){n(r)}):n(r)}else n()}var r=O.get(t);r.status<H.save?d(t,e):e()})}}),i(O.prototype,{_compile:function(){function t(t){t=l(t);var n=O.cache[t];return n?n.status===H.compiling?n.exports:(n.parent=e,n._compile()):null}var e=this;if(e.status===H.compiled)return e.exports;if(e.status<H.save)return null;e.status=H.compiling,t.cache=O.cache,e.require=t,e.exports={};var n=e.factory;return a(n)&&runModuleContext(n,e),e.status=H.compiled,e.exports},_save:function(t,e){this.status<H.save&&(this.id=l(t.id,e),this.dependencies=t.deps,this.factory=t.factory,this.status=H.save)}}),t.lithe=O,t.define=lithe.define,F&&t.lithe.use(F)}else exports.tool=require("./lib/lithe-tool.js"),exports.hfs=require("./lib/lithe-hfs.js")})(this);