/**
lithe
@author  []
@fileoverview a javascript common loader
@vserion 0.3.4
**/
!function(a,b){var c=!(typeof window===b||!a.navigator||!a.document);if(c){var d=a.document,e=Array.prototype,f=Object,g=f.prototype.toString,h=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/gm,i=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,j=e.forEach?function(a,b){a.forEach(b)}:function(a,b){for(var c=0;c<a.length;c++)b(a[c],c,a)},k=e.filter?function(a,b){return a.filter(b)}:function(a,b){var c=[];return j(a,function(a,d,e){b(a,d,e)&&c.push(a)}),c},l=e.map?function(a,b){return a.map(b)}:function(a,b){var c=[];return j(a,function(a,d,e){c.push(b(a,d,e))}),c},m=f.keys?f.keys:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},n=(e.indexOf?function(a,b){return a.indexOf(b)}:function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return c;return-1},function(a,b){return b=b||d,b?b.getElementsByTagName(a):b}),o=function(){},p=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},q=function(a){return"[object String]"===g.call(a)},r=function(a){return"[object Function]"===g.call(a)},s=function(a){return"[object Array]"===g.call(a)},t=function(a){var b={};return j(a,function(a){b[a]=1}),m(b)},u=function(a,b){return a.getAttribute(b)},v=function(a){var b=[];return a.replace(h,"").replace(i,function(a,c){b.push(c)}),t(b)},w=function(a,c){var d=a(c.require,c.exports,c);d!==b&&(c.exports=d)},x=function(){this.map={}};p(x.prototype,{trigger:function(a,b){var c=this.map[a];c&&j(c,function(a){a.apply(this,b)})},on:function(a,b){this.map[a]?this.map[a].push(b):this.map[a]=[b]}});var y=new x,z=function(a){for(var b=a.slice(a.lastIndexOf("?")+1).split("&"),c=0;c<b.length;c++){var d=b[c].split("="),e=d[0],f=d[1];if("timestamp"===e)return f}return null},A=function(a){return a.indexOf("://")>0||0===a.indexOf("//")},B=function(a){return!D(a)},C=function(a){var b=a.match(/[^?]*(?=\/.*$)/);return(b?b[0]:".")+"/"},D=function(a){return a.slice(a.lastIndexOf("/")+1).replace(/\?.*$/,"")},E=function(a){var b=/([^:\/])\/\/+/g;if(b.lastIndex=0,b.test(a)&&(a=a.replace(b,"$1/")),-1===a.indexOf("."))return a;for(var c,d=a.split("/"),e=[],f=0;f<d.length;f++)if(c=d[f],".."===c){if(0===e.length)throw new Error("The path is invalid: "+a);e.pop()}else"."!==c&&e.push(c);return e.join("/")},F=function(a,b){a=E(a);var c=a.charAt(a.length-1);return"/"===c?a:("#"===c?a=a.slice(0,-1):-1!==a.indexOf("?")||/\.(?:js|css)$/.test(a)||(a+=".js"),a.indexOf(":80/")>0&&(a=a.replace(":80/","/")),b&&(a=a.replace(/\?.+$/,"")),a)},G=function(a){var b,c,d,e,f,g={};for(b=0;b<eb.length&&!g[a];b++){e=eb[b];for(f in e)if(c=e[f],d=new RegExp("^"+f+"/"),d.test(a)&&!g[a]){a=a.replace(d,c),g[a]=!0;break}}return a},H=function(a){var b=bb.alias;if(b){var c=b[a];return c?c:G(a)}return a},I=function(a,b){if(b=C(b||ob.basepath),A(a))return a;Y&&(a=H(a));var c="";return 0===a.indexOf("./")||0===a.indexOf("../")?(0===a.indexOf("./")&&(a=a.substring(2)),c=b+a):c="/"===a.charAt(0)&&"/"!==a.charAt(1)?b+a.substring(1):b+"/"+a,F(c)},J=d.head||n("head")[0]||d.documentElement,K=n("script"),L=K[K.length-1],M=L.src||u(L,"src"),N=u(L,"data-path")||M,O=u(L,"data-config"),P=u(L,"charset")||"utf8",Q="true"===u(L,"data-debug"),R=z(L.src),S=null,T=u(L,"data-main"),U={},V={},W={};N=N===M?C(M):I(N,C(M));var X=function(a,b){y.trigger("fetch",[a,b])};y.on("fetch",function(a,b){if(!/\.css$/.test(a)){if(W[a])return b(),void 0;if(U[a])return V[a].push(b),void 0;U[a]=!0,V[a]=[b],Z(a,function(){W[a]=!0,delete U[a];var b=V[a];b&&(delete V[a],j(b,function(a){a()}))},P)}});var Y,Z=function(a,c,d){var e=$("script",d),f=s(a)?a.shift():a;if(!f)throw new Error("getscript url is "+f);e.onload=e.onerror=e.onreadystatechange=function(){/loaded|complete|undefined/.test(e.readyState)&&(e.onload=e.onerror=e.onreadystatechange=null,e.parentNode&&!Q&&e.parentNode.removeChild(e),e=b,s(a)&&a.length?Z(a,c,d):r(c)&&c())},e.async="async";var g=S?S:R;f=g?f+"?timestamp="+g:f,e.src=f,_(e)},$=function(a,b){var c=d.createElement(a);return c.charset=b?b:P,c},_=function(a){var b=n("base",J)[0];b?J.insertBefore(a,b):J.appendChild(a)},ab=[],bb={},cb={created:0,save:1,ready:2,compiling:3,compiled:4},db=[],eb=[],fb=function(a){var b=a.id,c=k(a.dependencies,function(a){db.push(b);var c=gb(ob.cache[I(a)]);return c&&db.push(b),db.pop(),!c});return ib(c)},gb=function(a){if(!a||a.status!==cb.save)return!1;db.push(a.id);var b=a.dependencies;if(b.length){if(hb(b,db))return!0;for(var c=0;c<b.length;c++)if(gb(ob.cache[I(b[c])]))return!0}return db.pop(),!1},hb=function(a,b){var c=a.concat(b);return c.length>t(c).length},ib=function(a){return q(a)&&(a=[a]),l(a,function(a){return I(a)})},jb=function(a,b){a=ib(a),y.trigger("start",[a]);var c=k(a,function(a){return a&&(!ob.cache[a]||ob.cache[a].status<cb.ready)}),d=c.length;if(0===d)return b(),void 0;var e=d,f=function(a){(a||{}).status<cb.ready&&(a.status=cb.ready),--e,0===e&&b()};j(c,function(a){function b(a){if(y.trigger("fetchsuccess",[c,a]),c.status>=cb.save){var b=fb(c);b.length?jb(b,function(){f(c)}):f(c)}else a?f(c):f()}var c=ob.get(a);c.status<cb.save?X(a,b):b()})},kb=function(){j(ab,function(a){var b=ob.get(a.id);b._save(a)}),ab=[]},lb=function(a,b){jb(a,function(){a=ib(a);var c=l(a,function(a){return a?ob.get(a)._compile():null});r(b)&&b.apply(null,c),y.trigger("end")})},mb=function(a){bb=a,eb=[];var b,c,d,e=bb.alias;if(e)for(b in e)c=e[b],B(c)&&(d={},d[b]=c,eb.push(d));Y=!0,bb.basepath&&(ob.basepath=bb.basepath),ob.config=bb,S=bb.timestamp},nb=function(a){this.id=a,this.status=0,this.dependencies=[],this.exports=null,this.parent=[],this.factory=o};p(nb.prototype,{_compile:function(){function a(a){a=F(I(a),!0);var c=ob.cache[a];return c?c.status===cb.compiling?c.exports:(c.parent=b,c._compile()):null}var b=this;if(b.status===cb.compiled)return b.exports;if(b.status<cb.save)return null;b.status=cb.compiling,a.cache=ob.cache,b.require=a,b.exports={};var c=b.factory;return r(c)&&w(c,b),b.status=cb.compiled,ob.events.trigger("compiled",[b]),b.exports},_save:function(a){this.status<cb.save&&(this.id=a.id,this.name=a.name,this.dependencies=a.deps,this.factory=a.factory,this.status=cb.save)}});var ob=p({basepath:N,events:y,cache:{},get:function(a){return a=F(a,!0),ob.cache[a]?ob.cache[a]:(ob.cache[a]=new nb(a),ob.cache[a])},define:function(a,b){var c=v(b.toString()),d={id:I(a),name:a,deps:c,factory:b};ab.push(d),kb()},use:function(a,b){!O||Y?lb(a,b):lb(O,function(c){mb(c),lb(a,b)})},load:Z});O&&(O=ib(O)),a.lithe=ob,a.define=ob.define,T&&setTimeout(function(){a.lithe.use(T)})}else exports.tool=require("./lib/lithe-tool.js"),exports.hfs=require("./lib/lithe-hfs.js")}(this);